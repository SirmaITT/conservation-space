/**
 * A skype-like placeholder text for tinymce. 
 * When the user moves the focus away from the editor and there is no text or
 * "content-making" elements e.g img, empty li tags, etc a hint text is displayed.
 * When the user focuses the editor the text is removed.
 */
tinymce.PluginManager.add("textPlaceholder", function(editor) {
	
	var placeholder = editor.settings._placeholder,
		placeholderHtml = '<div class="textPlaceholder"><span class="text-muted">' + placeholder +'</span></div>';
	
	/**
	 * Check if there're any "content making" elements in the editor.
	 * Check element.innerText is empty string AND
	 * no elements that create content are present e.g. img, empty li tags.
	 */
	function isEmpty() {
		var editorDomElement = editor.getElement(),
			editorText 	=  editorDomElement && (editorDomElement.innerText || editorDomElement.textContent),
			noText 		= !editorText || (editorText && !editorText.trim()),
			nonTextContentElements = editorDomElement && editorDomElement.querySelectorAll('li, img'),
			noNonTextContentElements = (!nonTextContentElements || !nonTextContentElements.length);
		
		return (noText && noNonTextContentElements);
	}
	
	function addPlaceholder() {
		editor.setContent(placeholderHtml);
	}
	
	function removePlaceholder() {
		var editorDomUtil = editor.dom,
			editorSelectionUtil,
			placeholderNodeArray = editorDomUtil.select('.textPlaceholder'),
			placeholderNode,
			placeholderParentNode,
			bookmark;
		
		if (placeholderNodeArray && placeholderNodeArray.length) {
			editorSelectionUtil = editor.selection;
			
			placeholderNode = placeholderNodeArray[0];
			bookmark = editorSelectionUtil.getBookmark();;
			editorDomUtil.remove(placeholderNode);
			editorSelectionUtil.moveToBookmark(bookmark);
		}
	
	}
	
	function handleEvent(event) {
		var eventType = event.type;
		if (eventType === 'focus') {
			setTimeout(function() { removePlaceholder(); }, 0);
		} else if (eventType === 'blur' && isEmpty()) {
			addPlaceholder();
		}
	}
	
	// scumbag tinymce not firing event for after init that can be catched in plugins
	editor.on('TextPlaceholderAfterInit', function(event) {
		handleEvent({ type: 'blur' });
	});
	
	editor.on('Focus Blur', handleEvent);
});