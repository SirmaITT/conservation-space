<?xml version="1.0"?>
<project name="pm-schedule-web" basedir="." default="js.strip">
	<description>
		Build file to concatenate and minify scheduler and resource allocation javascript implementations.
	</description>
	
	<property name="app.dest" location="${basedir}/src/main/resources/META-INF/resources/js/app/"/>
	
	<target name="js.concatenate">
		<echo message="Concatenating scheduler files." />
        <concat destfile="${app.dest}/pmsch-scheduler-min.js">
            <fileset dir="${app.dest}">
        		<include name="schedule-app.js" />
        		<include name="GanttPanel.js" />
        		<include name="TaskContextMenu.js" />
            	<include name="TaskForm.js" />
    			<include name="Toolbar.js" />
    			<include name="controller/ScheduleController.js" />
            	<include name="model/PMResourceAllocationModel.js" />
				<include name="model/PMResourceStore.js" />
				<include name="model/PMTaskModel.js" />
            	<include name="widget/PMAssignmentGrid.js" />
				<include name="widget/taskeditor/PMTaskEditor.js" />
            </fileset>
        </concat>
		<echo message="Concatenating resource allocation files." />
        <concat destfile="${app.dest}/pmsch-resource-allocation-min.js">
            <fileset dir="${app.dest}">
        		<include name="resource-allocation-app.js" />
        		<include name="ResourceAllocationPanel.js" />
            	<include name="ResourceAllocationToolbar.js" />
        		<include name="model/PMResourceAllocationModel.js" />
        	</fileset>
        </concat>
	</target>

	<target name="js.strip" depends="js.minify">
		<echo message="Remove extJS requires configurations." />
		
		<replaceregexp  file="${app.dest}/pmsch-scheduler-min.js" match="requires:\[([^]]+)\],?" replace=""/>
		<replaceregexp  file="${app.dest}/pmsch-scheduler-min.js" match="Ext.require\(\[([^]]+)\]\)" replace=""/>
		
		<replaceregexp  file="${app.dest}/pmsch-resource-allocation-min.js" match="requires:\[([^]]+)\],?" replace=""/>
		<replaceregexp  file="${app.dest}/pmsch-resource-allocation-min.js" match="Ext.require\(\[([^]]+)\]\)" replace=""/>
		
	</target>
	
	<target name="js.minify" depends="js.concatenate">
		<echo message="Minify scheduler." />
	    <java jar="lib/yuicompressor-2.4.7.jar" fork="true">
	        <arg value="${app.dest}/pmsch-scheduler-min.js"/>
	    	<arg value="-o"/>
	        <arg value="${app.dest}/pmsch-scheduler-min.js"/>
	    </java>
		
		<echo message="Minify resource allocation." />
	    <java jar="lib/yuicompressor-2.4.7.jar" fork="true">
	        <arg value="${app.dest}/pmsch-resource-allocation-min.js"/>
	    	<arg value="-o"/>
	        <arg value="${app.dest}/pmsch-resource-allocation-min.js"/>
	    </java>
	</target>
</project>