<?xml version="1.0"?>
<definition id="timerEndDateTomorrowTask" type="timer" isAbstract="false">
	<fields>
		<field name="timerEndDateTomorrowTask" type="an..200" displayType="system">
			<value><![CDATA[
					// process emf:Task
					// state IN_PROGRESS, NOT_YET_STARTED, ON_HOLD 
					var arguments = new com.sirma.itt.seip.context.Context();
					arguments.put('todayPlus', 1);
					arguments.put('type', 'emf:Task');
					arguments.put('statement', '{?instance emf\\:status \\"IN_PROGRESS\\" . } UNION {?instance emf\\:status \\"NOT_YET_STARTED\\" . } UNION { ?instance emf\\:status \\"ON_HOLD\\" . }');
					var emfTask = search.with(search.buildArgumentsForPredefinedQuery('ciaQueries/getInstanceNearEnd', arguments));
						
					var assigneesProperties = ['assignee', 'emf:hasAssignee', 'createdBy', 'emf:createdBy', 'hasWatcher', 'emf:hasWatcher'];
					
					for(var i=0; i < emfTask.length; i++){
						var subject ='(Upcoming Due date) '+ emfTask[i].get('title');
						var recipients = tasks.getTaskAssignees(emfTask[i] ,assigneesProperties);
						mail.sendNotifications(emfTask[i], security.getCurrentLoggedUser(), subject, "email_endDate_object_cia", recipients, null);
					}
					
					// process emf:BusinessProcessTask
					arguments.clear();
					arguments.put('todayPlus', 1);
					arguments.put('type', 'emf:BusinessProcessTask');
					arguments.put('statement', '');
					var emfBusinessProcessTask = search.with(search.buildArgumentsForPredefinedQuery('ngaQueries/getInstanceNearEnd', arguments));
					
					var assigneesProperties = ['assignee', 'emf:hasAssignee', 'createdBy', 'emf:createdBy', 'emf:hasWatcher'];
					
					for(var i=0; i < emfBusinessProcessTask.length; i++){
						var subject ='(Upcoming Due date) '+ emfTask[i].get('title');
						var recipients = tasks.getTaskAssignees(emfBusinessProcessTask[i] ,assigneesProperties);
						mail.sendNotifications(emfBusinessProcessTask[i], security.getCurrentLoggedUser(), subject, "email_endDate_object_cia", recipients, null);
					}
				]]>
			</value>
			<control id="schedulerConfiguration">
				<!-- To be executed each day at 00:00 -->
				<control-param id="config" name="cronExpression">0 0 0 1/1 * ? *</control-param>
				<control-param id="config" name="persistent">true</control-param>
			</control>
		</field>
	</fields>
</definition>